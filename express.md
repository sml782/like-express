# `express` 原理分析

## 核心依赖

`NodeJS` 的 `http` 模块为基础

- 依赖 `http` 创建的服务
- 添加中间层处理
- 再次丰富扩展 `req` 、 `res` 的属性及方法，其中包含 `cookie` 、`param` 、`header`以及返回数据的丰富

## 核心机制

### 什么是中间件？

1. 处理程序，说白了就是处理 `http` 请求的函数，特定的去做某一事情的函数。

### 注册中间件(也就是注册路由)

> 这里 `express` 把中间件和路由处理混入一谈，有时可能觉得不方便，有点乱。
> 有空可看先 Koa2 的实现，这里不多赘述。

#### 这里有 2 种方式注册

1. 通过 `express` 主程序去接收注册的中间件，然后派发给 `Router` 中间层
2. 通过 `express` 主程序注册中间件，`Router` 自己去接收路由。
3. 注册 `errorHandle` 或者其他 `404` 页面等时，最好放在最后，好兜底，保证正常运行

#### 通过主程序去接收注册的中间件时的方法

1. `use()`: 注册所有系统中间件，通用
2. `all()`: 注册所有方法路由，通用
3. `get()|post()...`: 注册基本方法路由，单方法
4. 其他

#### `use()` 和 `all()` 的区别：

这里 `all()` 不仅仅是 `all()` ，是代表所有接收路由的函数。<br />从严格意义上讲：

1. 注册的东西不同，`use()` 是注册中间件，而 `all()` 是注册路由。
2. 处理的东西，`use()` 一般不处理请求和响应，只处理输入相关数据，而 `all()` 只处理请求和响应。
3. 路由匹配不同，`use()` 是只要配置路由在当前路径首位就能匹配到并执行，而 `all()` 等则是精确匹配。

### 中间件怎么执行?

1. 一个一个串联起来，形成执行栈执行队列
2. 通过中间件管理器来操作下一步应该干啥
3. 顺序执行，传递执行
4. 如果到最后都没找到，直接进入404处理
5. 如遇到错误，处理首先寻找自定义`errorhandle` ，这里也是正向遍历中间件队列，有则执行，没有执行内部定义 `errorhandle`

![Untitled Diagram.png](https://cdn.nlark.com/yuque/0/2020/png/159686/1578292108032-5e0cff4f-97c5-4df6-a2bd-d46cb2351597.png#align=left&display=inline&height=741&name=Untitled%20Diagram.png&originHeight=741&originWidth=636&size=68511&status=done&style=none&width=636)

#### 这里是怎么找到 `errorHandle` 中间件的？

`function` 上有个属性叫 `length` ，这个代表函数入参的个数，这里就断定如果入参为 `4` 个，就是 `errorHandle `, 比较傻瓜式的判断。
